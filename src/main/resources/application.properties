spring.application.name=rdpk
server.port=8080

# Database Configuration - R2DBC PostgreSQL
spring.r2dbc.url=r2dbc:postgresql://localhost:5432/votacao
spring.r2dbc.username=votacao
spring.r2dbc.password=votacao
spring.r2dbc.pool.initial-size=10
spring.r2dbc.pool.max-size=30
spring.r2dbc.pool.max-idle-time=30m

# Flyway Configuration (uses JDBC for migrations)
spring.flyway.enabled=true
spring.flyway.url=jdbc:postgresql://localhost:5432/votacao
spring.flyway.user=votacao
spring.flyway.password=votacao
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true

# CPF validation service URL (our own service)
cpf.validation.url=http://localhost:8080/api/v1/cpf-validation

# CPF Validation Configuration - Default to strict for production
cpf.validation.lenient=false

# ============================================
# Resilience4j Configuration
# ============================================

# Circuit Breaker - CPF Validation
resilience4j.circuitbreaker.instances.cpfValidation.register-health-indicator=true
resilience4j.circuitbreaker.instances.cpfValidation.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.cpfValidation.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.cpfValidation.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.cpfValidation.wait-duration-in-open-state=10s
resilience4j.circuitbreaker.instances.cpfValidation.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.cpfValidation.sliding-window-size=10
resilience4j.circuitbreaker.instances.cpfValidation.sliding-window-type=COUNT_BASED

# Circuit Breaker - Database
resilience4j.circuitbreaker.instances.database.register-health-indicator=true
resilience4j.circuitbreaker.instances.database.failure-rate-threshold=60
resilience4j.circuitbreaker.instances.database.minimum-number-of-calls=10
resilience4j.circuitbreaker.instances.database.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.instances.database.sliding-window-size=20
resilience4j.circuitbreaker.instances.database.sliding-window-type=COUNT_BASED

# Retry - CPF Validation (transient network failures)
resilience4j.retry.instances.cpfValidation.max-attempts=3
resilience4j.retry.instances.cpfValidation.wait-duration=500ms
resilience4j.retry.instances.cpfValidation.exponential-backoff-multiplier=2
resilience4j.retry.instances.cpfValidation.retry-exceptions=java.net.ConnectException,java.net.SocketTimeoutException,org.springframework.web.reactive.function.client.WebClientRequestException

# Retry - Database (transient DB failures, deadlocks)
resilience4j.retry.instances.database.max-attempts=3
resilience4j.retry.instances.database.wait-duration=100ms
resilience4j.retry.instances.database.exponential-backoff-multiplier=2
resilience4j.retry.instances.database.retry-exceptions=io.r2dbc.spi.R2dbcTransientException,io.r2dbc.spi.R2dbcTimeoutException

# Time Limiter - Operation Timeouts
resilience4j.timelimiter.instances.cpfValidation.timeout-duration=3s
resilience4j.timelimiter.instances.database.timeout-duration=5s
resilience4j.timelimiter.instances.voteSubmission.timeout-duration=10s

# Bulkhead - Resource Isolation (Semaphore-based for reactive)
resilience4j.bulkhead.instances.cpfValidation.max-concurrent-calls=50
resilience4j.bulkhead.instances.cpfValidation.max-wait-duration=100ms
resilience4j.bulkhead.instances.database.max-concurrent-calls=100
resilience4j.bulkhead.instances.database.max-wait-duration=50ms

# Rate Limiter - API Protection
resilience4j.ratelimiter.instances.voteSubmission.limit-for-period=200
resilience4j.ratelimiter.instances.voteSubmission.limit-refresh-period=1s
resilience4j.ratelimiter.instances.voteSubmission.timeout-duration=0ms
resilience4j.ratelimiter.instances.voteSubmission.register-health-indicator=true

# Actuator - Expose resilience metrics
management.health.circuitbreakers.enabled=true
management.health.ratelimiters.enabled=true
management.endpoints.web.exposure.include=health,metrics,circuitbreakers,ratelimiters,retries


# Resilience Testing Profile
# Aggressive settings to test circuit breakers and resilience patterns

# ============================================
# Connection Pool Configuration
# ============================================

# R2DBC Connection Pool - Reduced for resilience testing
spring.r2dbc.pool.initial-size=5
spring.r2dbc.pool.max-size=20
spring.r2dbc.pool.max-idle-time=30m

# ============================================
# Aggressive Resilience4j Configuration for Testing
# ============================================

# Circuit Breaker - CPF Validation (Aggressive for testing)
resilience4j.circuitbreaker.instances.cpfValidation.register-health-indicator=true
resilience4j.circuitbreaker.instances.cpfValidation.failure-rate-threshold=30
resilience4j.circuitbreaker.instances.cpfValidation.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.cpfValidation.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.cpfValidation.wait-duration-in-open-state=2s
resilience4j.circuitbreaker.instances.cpfValidation.permitted-number-of-calls-in-half-open-state=2
resilience4j.circuitbreaker.instances.cpfValidation.sliding-window-size=10
resilience4j.circuitbreaker.instances.cpfValidation.sliding-window-type=COUNT_BASED

# Circuit Breaker - Database (Aggressive for testing)
resilience4j.circuitbreaker.instances.database.register-health-indicator=true
resilience4j.circuitbreaker.instances.database.failure-rate-threshold=40
resilience4j.circuitbreaker.instances.database.minimum-number-of-calls=5
resilience4j.circuitbreaker.instances.database.wait-duration-in-open-state=3s
resilience4j.circuitbreaker.instances.database.sliding-window-size=10
resilience4j.circuitbreaker.instances.database.sliding-window-type=COUNT_BASED

# Retry - CPF Validation (Minimal for testing)
resilience4j.retry.instances.cpfValidation.max-attempts=1
resilience4j.retry.instances.cpfValidation.wait-duration=100ms
resilience4j.retry.instances.cpfValidation.exponential-backoff-multiplier=1.0
resilience4j.retry.instances.cpfValidation.retry-exceptions=java.net.ConnectException,java.net.SocketTimeoutException,org.springframework.web.reactive.function.client.WebClientRequestException

# Retry - Database (Minimal for testing)
resilience4j.retry.instances.database.max-attempts=1
resilience4j.retry.instances.database.wait-duration=50ms
resilience4j.retry.instances.database.exponential-backoff-multiplier=1.0
resilience4j.retry.instances.database.retry-exceptions=io.r2dbc.spi.R2dbcTransientException,io.r2dbc.spi.R2dbcTimeoutException

# Time Limiter - Short timeouts for resilience testing
resilience4j.timelimiter.instances.cpfValidation.timeout-duration=1s
resilience4j.timelimiter.instances.database.timeout-duration=2s
resilience4j.timelimiter.instances.voteSubmission.timeout-duration=3s

# Bulkhead - Very low limits for resilience testing
resilience4j.bulkhead.instances.cpfValidation.max-concurrent-calls=10
resilience4j.bulkhead.instances.cpfValidation.max-wait-duration=50ms
resilience4j.bulkhead.instances.database.max-concurrent-calls=20
resilience4j.bulkhead.instances.database.max-wait-duration=25ms

# Rate Limiter - Very low limits for resilience testing
resilience4j.ratelimiter.instances.voteSubmission.limit-for-period=50
resilience4j.ratelimiter.instances.voteSubmission.limit-refresh-period=1s
resilience4j.ratelimiter.instances.voteSubmission.timeout-duration=0ms
resilience4j.ratelimiter.instances.voteSubmission.register-health-indicator=true

# Actuator - Expose resilience metrics for testing
management.health.circuitbreakers.enabled=true
management.health.ratelimiters.enabled=true
management.endpoints.web.exposure.include=health,metrics,circuitbreakers,ratelimiters,retries

# ============================================
# Resilience Testing Specific Settings
# ============================================

# Disable some features that might interfere with testing
spring.devtools.restart.enabled=false
spring.devtools.livereload.enabled=false

# Logging - More verbose for resilience testing
logging.level.com.rdpk=INFO
logging.level.org.springframework.web=WARN
logging.level.io.r2dbc=WARN
logging.level.io.netty=WARN
logging.level.io.github.resilience4j=INFO

# K6 Performance Testing Profile
# Relaxed Resilience4j settings for high-load testing scenarios

# ============================================
# Connection Pool Configuration
# ============================================

# R2DBC Connection Pool - Increased for k6 testing
spring.r2dbc.pool.initial-size=20
spring.r2dbc.pool.max-size=50
spring.r2dbc.pool.max-idle-time=30m

# ============================================
# Relaxed Resilience4j Configuration for K6 Testing
# ============================================

# Circuit Breaker - CPF Validation (Relaxed for testing)
resilience4j.circuitbreaker.instances.cpfValidation.failure-rate-threshold=80
resilience4j.circuitbreaker.instances.cpfValidation.minimum-number-of-calls=10
resilience4j.circuitbreaker.instances.cpfValidation.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.cpfValidation.wait-duration-in-open-state=5s
resilience4j.circuitbreaker.instances.cpfValidation.permitted-number-of-calls-in-half-open-state=5
resilience4j.circuitbreaker.instances.cpfValidation.sliding-window-size=20
resilience4j.circuitbreaker.instances.cpfValidation.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.cpfValidation.register-health-indicator=true

# Circuit Breaker - Database (Relaxed for testing)
resilience4j.circuitbreaker.instances.database.failure-rate-threshold=80
resilience4j.circuitbreaker.instances.database.minimum-number-of-calls=20
resilience4j.circuitbreaker.instances.database.automatic-transition-from-open-to-half-open-enabled=true
resilience4j.circuitbreaker.instances.database.wait-duration-in-open-state=10s
resilience4j.circuitbreaker.instances.database.permitted-number-of-calls-in-half-open-state=5
resilience4j.circuitbreaker.instances.database.sliding-window-size=50
resilience4j.circuitbreaker.instances.database.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.database.register-health-indicator=true

# Retry - CPF Validation (More lenient for testing)
resilience4j.retry.instances.cpfValidation.max-attempts=2
resilience4j.retry.instances.cpfValidation.wait-duration=200ms
resilience4j.retry.instances.cpfValidation.exponential-backoff-multiplier=1.5
resilience4j.retry.instances.cpfValidation.retry-exceptions=java.net.ConnectException,java.net.SocketTimeoutException,org.springframework.web.reactive.function.client.WebClientRequestException

# Retry - Database (More lenient for testing)
resilience4j.retry.instances.database.max-attempts=2
resilience4j.retry.instances.database.wait-duration=50ms
resilience4j.retry.instances.database.exponential-backoff-multiplier=1.5
resilience4j.retry.instances.database.retry-exceptions=io.r2dbc.spi.R2dbcTransientException,io.r2dbc.spi.R2dbcTimeoutException

# Time Limiter - Extended timeouts for k6 testing
resilience4j.timelimiter.instances.cpfValidation.timeout-duration=10s
resilience4j.timelimiter.instances.database.timeout-duration=10s
resilience4j.timelimiter.instances.voteSubmission.timeout-duration=15s

# Bulkhead - CPF Validation (Much increased capacity for k6 testing)
resilience4j.bulkhead.instances.cpfValidation.max-concurrent-calls=1000
resilience4j.bulkhead.instances.cpfValidation.max-wait-duration=1000ms

# Bulkhead - Database (Much increased capacity for k6 testing)
resilience4j.bulkhead.instances.database.max-concurrent-calls=1000
resilience4j.bulkhead.instances.database.max-wait-duration=1000ms

# Rate Limiter - Vote Submission (Much higher limits for k6 testing)
resilience4j.ratelimiter.instances.voteSubmission.limit-for-period=10000
resilience4j.ratelimiter.instances.voteSubmission.limit-refresh-period=1s
resilience4j.ratelimiter.instances.voteSubmission.timeout-duration=500ms
resilience4j.ratelimiter.instances.voteSubmission.register-health-indicator=true

# Actuator - Expose resilience metrics for k6 monitoring
management.health.circuitbreakers.enabled=true
management.health.ratelimiters.enabled=true
management.endpoints.web.exposure.include=health,metrics,circuitbreakers,ratelimiters,retries

# ============================================
# K6 Testing Specific Settings
# ============================================

# Disable some features that might interfere with testing
spring.devtools.restart.enabled=false
spring.devtools.livereload.enabled=false

# Logging - Clean output for k6 testing
logging.level.com.rdpk=WARN
logging.level.org.springframework.web=WARN
logging.level.io.r2dbc=WARN
logging.level.io.netty=WARN
logging.level.io.github.resilience4j=WARN
logging.level.org.springframework.boot.autoconfigure=WARN
